From a34e35599f2b6ada2ab828462616a5afb3d2c34a Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Fri, 10 Oct 2025 08:58:12 +0000
Subject: [PATCH] imx8mp-var-dart: integrate with balenaOS

Upstream-status: Inappropriate[configuration]
Signed-off-by: Florin Sarbu <florin@balena.io>
---
 include/configs/imx8mp_var_dart.h | 20 +++++++++++++-------
 1 file changed, 13 insertions(+), 7 deletions(-)

diff --git a/include/configs/imx8mp_var_dart.h b/include/configs/imx8mp_var_dart.h
index 4f011007830..d3424256d26 100644
--- a/include/configs/imx8mp_var_dart.h
+++ b/include/configs/imx8mp_var_dart.h
@@ -81,11 +81,11 @@
 	"kernel_addr_r=" __stringify(CONFIG_SYS_LOAD_ADDR) "\0" \
 	"bsp_script=boot.scr\0" \
 	"image=Image.gz\0" \
-	"img_addr=0x42000000\0" \
+	"img_addr=0x48440000\0" \
 	"splashimage=0x4F600000\0" \
 	"console=ttymxc0,115200\0" \
-	"fdt_addr_r=0x43000000\0" \
-	"fdt_addr=0x43000000\0"			\
+	"fdt_addr_r=0x45000000\0" \
+	"fdt_addr=0x45000000\0"			\
 	"fdt_high=0xffffffffffffffff\0"		\
 	"boot_fdt=try\0" \
 	"boot_fit=no\0" \
@@ -115,12 +115,12 @@
 		"bootaux ${m7_addr};\0" \
 	"optargs=setenv bootargs ${bootargs} ${kernelargs};\0" \
 	"mmcargs=setenv bootargs console=${console} " \
-		"root=/dev/mmcblk${mmcblk}p${mmcpart} rootwait rw ${cma_size} cma_name=linux,cma\0 " \
+		"${resin_kernel_root} ${os_cmdline} rootwait rw ${cma_size} cma_name=linux,cma\0 " \
 	"loadbootscript=load mmc ${mmcdev}:${mmcpart} ${loadaddr} ${bootdir}/${bsp_script};\0" \
 	"bootscript=echo Running bootscript from mmc ...; " \
 		"source\0" \
-	"loadimage=load mmc ${mmcdev}:${mmcpart} ${img_addr} ${bootdir}/${image};" \
-		"unzip ${img_addr} ${loadaddr}\0" \
+	"loadimage=if load mmc ${resin_dev_index}:${resin_root_part} ${img_addr} boot/${image}; then " \
+		"unzip ${img_addr} ${loadaddr}; run balena_kernel_load_crc_save; else false; fi; \0" \
 	"findfdt=" \
 		"if test $fdt_file = undefined; then " \
 			"if test $board_name = VAR-SOM-MX8M-PLUS; then " \
@@ -135,7 +135,7 @@
 		"fi; \0" \
 	"loadfdt=run findfdt; " \
 		"echo fdt_file=${fdt_file}; " \
-		"load mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${bootdir}/${fdt_file}\0" \
+		"if load mmc ${resin_dev_index}:${resin_root_part} ${fdt_addr} boot/${fdt_file}; then echo Loaded ${fdt_file}; run balena_fdt_load_crc_save; else false; fi; \0" \
 	"ramsize_check="\
 		"if test $sdram_size -le 512; then " \
 			"setenv cma_size cma=320M; " \
@@ -153,6 +153,8 @@
 			"bootm ${loadaddr}; " \
 		"else " \
 			"if run loadfdt; then " \
+				"run balena_kernel_load_crc_check; " \
+				"run balena_fdt_load_crc_check; " \
 				"booti ${loadaddr} - ${fdt_addr_r}; " \
 			"else " \
 				"echo WARN: Cannot load the DT; " \
@@ -182,6 +184,10 @@
 			"fi; " \
 		"fi;\0" \
 	"bsp_bootcmd=echo Running BSP bootcmd ...; " \
+		"setenv resin_kernel_load_addr ${loadaddr}; " \
+		"run resin_set_kernel_root; run set_os_cmdline; " \
+		"setenv mmcdev ${resin_dev_index}; " \
+		"setenv mmcpart ${resin_root_part}; " \
 		"run ramsize_check; " \
 		"mmc dev ${mmcdev}; " \
 		"if mmc rescan; then " \
-- 
2.34.1

